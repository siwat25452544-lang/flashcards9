<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flashcards ‚Äì GoodNotes Style + English TTS</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">
<link rel="apple-touch-icon" href="assets/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Flashcards">

<style>
:root{--bg:#f6f7fb;--ink:#111;--muted:#6b7280;--white:#fff;--adj:#FFF9C4;--verb:#BBDEFB;--thing:#C8E6C9;--animal:#F8BBD0;--time:#FFE0B2;--card:#fff;--shadow:0 10px 25px rgba(0,0,0,.08)}
*{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans Thai","Noto Sans",sans-serif;background:var(--bg);color:var(--ink)}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fff,rgba(255,255,255,.92));backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #eee}
.wrap{max-width:1024px;margin:0 auto;padding:12px 16px} header h1{font-size:clamp(18px,2.5vw,22px);margin:0 0 8px}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{appearance:none;border:0;background:#111;color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);font-weight:800}
button:disabled{opacity:.5;cursor:not-allowed} .secondary{background:#fff;color:#111;border:1px solid #e5e7eb}
#btnSpeak{font-size:22px;padding:14px 18px;border-radius:16px}
.mini{display:flex;gap:8px;align-items:center;background:#fff;padding:8px 10px;border-radius:12px;box-shadow:var(--shadow)}
.mini label{font-size:12px;color:#6b7280} #rate{width:140px}
.setBadge{display:inline-flex;align-items:center;gap:6px;background:#111;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
select{padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;box-shadow:var(--shadow);font-weight:700}
.app{max-width:1024px;margin:0 auto;padding:16px} .stage{display:grid;grid-template-columns:1fr;justify-items:center}
.card{width:min(820px,94vw);aspect-ratio:4/3;border-radius:22px;box-shadow:var(--shadow);background:var(--card);position:relative;perspective:1000px;margin-top:12px}
.inner{position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform .5s ease}
.card.flipped .inner{transform:rotateY(180deg)} .face{position:absolute;inset:0;border-radius:22px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;backface-visibility:hidden}
.front{gap:8px} .word{font-size:clamp(38px,8.5vw,80px);font-weight:900;letter-spacing:.5px} .hint{font-size:14px;color:#6b7280;margin-top:6px}
.back{transform:rotateY(180deg);gap:12px;background:#f3f4f6} .thai{font-size:clamp(22px,3.5vw,34px);font-weight:800} .sentence{font-size:clamp(16px,2.5vw,22px);color:#1f2937}
.badge{position:absolute;top:14px;left:14px;background:rgba(0,0,0,.6);color:#fff;padding:6px 10px;border-radius:999px;font-size:12px}
.count{position:absolute;top:14px;right:14px;background:#111;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px}
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35)} .modal.open{display:grid}
.sheet{width:min(560px,92vw);background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:16px}
.sheet h3{margin:0 0 10px} .sheet .row{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
.pill{padding:10px 12px;border-radius:12px;background:#f3f4f6;cursor:pointer;font-weight:700} .pill:hover{background:#e5e7eb}
.muted{color:#6b7280;font-size:13px} .file{display:inline-block;padding:10px 12px;border-radius:12px;border:1px dashed #d1d5db;cursor:pointer}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Flashcards ‚Äì GoodNotes Style + ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</h1>
    <div class="toolbar">
      <span id="setBadge" class="setBadge">‡∏ä‡∏∏‡∏î <strong id="setNum">1</strong></span>
      <button id="btnKnow">‚úì ‡∏à‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß</button>
      <button id="btnAgain" class="secondary">‚ü≤ ‡∏¢‡∏±‡∏á‡∏à‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</button>
      <button id="btnSpeak">üîä ‡∏≠‡πà‡∏≤‡∏ô</button>
      <button id="btnSets" class="secondary">üìö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î</button>
      <div class="mini">
        <button id="btnGender" class="secondary" title="‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á">‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡∏´‡∏ç‡∏¥‡∏á</button>
        <label for="rate">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</label>
        <input id="rate" type="range" min="0.7" max="1.1" step="0.05" value="0.9" />
        <span id="rateLbl" style="font-size:12px;color:#6b7280">0.90x</span>
        <select id="voiceSelect" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î (iPad/iPhone ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Samantha/Karen Enhanced)">
          <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</option>
        </select>
      </div>
    </div>
  </div>
</header>

<main class="app">
  <section class="stage">
    <div class="card" id="card">
      <div class="inner">
        <div class="face front" id="front">
          <span class="badge" id="catBadge">adjective</span>
          <span class="count" id="count">1 / 30</span>
          <div class="word" id="word">happy</div>
          <div class="hint">‡πÅ‡∏ï‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏•‡∏¥‡∏Å</div>
        </div>
        <div class="face back" id="back">
          <span class="badge" id="catBadgeBack">adjective</span>
          <span class="count" id="countBack">1 / 30</span>
          <div class="thai" id="thai">‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç</div>
          <div class="sentence" id="sentence">I am happy today.</div>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="modal" class="modal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true">
    <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</h3>
    <div class="row" id="setRow"></div>
    <p class="muted">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å): JSON ‡∏´‡∏£‡∏∑‡∏≠ CSV (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: w, th, s, cat)</p>
    <label class="file">
      <input type="file" id="fileInput" accept=".json,.csv" hidden />üì• ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå...
    </label>
    <div style="margin-top:10px"><button id="closeModal" class="secondary">‡∏õ‡∏¥‡∏î</button></div>
  </div>
</div>

<script>
const SETS={
  1:[{w:'happy',th:'‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç',s:'I am happy today.',cat:'adj'},{w:'angry',th:'‡πÇ‡∏Å‡∏£‡∏ò',s:'She is angry.',cat:'adj'},{w:'hungry',th:'‡∏´‡∏¥‡∏ß',s:'I am hungry.',cat:'adj'},{w:'thirsty',th:'‡∏Å‡∏£‡∏∞‡∏´‡∏≤‡∏¢‡∏ô‡πâ‡∏≥',s:'He is thirsty.',cat:'adj'},{w:'clean',th:'‡∏™‡∏∞‡∏≠‡∏≤‡∏î',s:'The room is clean.',cat:'adj'},{w:'dirty',th:'‡∏™‡∏Å‡∏õ‡∏£‡∏Å',s:'The floor is dirty.',cat:'adj'},{w:'listen',th:'‡∏ü‡∏±‡∏á',s:'Listen to the music.',cat:'verb'},{w:'speak',th:'‡∏û‡∏π‡∏î',s:'I speak English.',cat:'verb'},{w:'draw',th:'‡∏ß‡∏≤‡∏î',s:'Draw a picture.',cat:'verb'},{w:'swim',th:'‡∏ß‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥',s:'I can swim.',cat:'verb'},{w:'run',th:'‡∏ß‡∏¥‡πà‡∏á',s:'Run fast!',cat:'verb'},{w:'jump',th:'‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î',s:'Jump high!',cat:'verb'},{w:'window',th:'‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á',s:'Open the window.',cat:'thing'},{w:'door',th:'‡∏õ‡∏£‡∏∞‡∏ï‡∏π',s:'Close the door.',cat:'thing'},{w:'floor',th:'‡∏û‡∏∑‡πâ‡∏ô',s:'Clean the floor.',cat:'thing'},{w:'roof',th:'‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≤',s:'The roof is red.',cat:'thing'},{w:'street',th:'‡∏ñ‡∏ô‡∏ô',s:'The street is busy.',cat:'thing'},{w:'market',th:'‡∏ï‡∏•‡∏≤‡∏î',s:'Go to the market.',cat:'thing'},{w:'dog',th:'‡∏™‡∏∏‡∏ô‡∏±‡∏Ç',s:'The dog is big.',cat:'animal'},{w:'cat',th:'‡πÅ‡∏°‡∏ß',s:'The cat is cute.',cat:'animal'},{w:'bird',th:'‡∏ô‡∏Å',s:'A bird can fly.',cat:'animal'},{w:'fish',th:'‡∏õ‡∏•‡∏≤',s:'A fish can swim.',cat:'animal'},{w:'elephant',th:'‡∏ä‡πâ‡∏≤‡∏á',s:'The elephant is big.',cat:'animal'},{w:'tiger',th:'‡πÄ‡∏™‡∏∑‡∏≠',s:'The tiger is strong.',cat:'animal'},{w:'morning',th:'‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤',s:'Good morning!',cat:'time'},{w:'afternoon',th:'‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢',s:'Good afternoon.',cat:'time'},{w:'evening',th:'‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô',s:'Good evening.',cat:'time'},{w:'night',th:'‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô',s:'Good night.',cat:'time'},{w:'yesterday',th:'‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô',s:'I saw him yesterday.',cat:'time'},{w:'tomorrow',th:'‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ',s:'See you tomorrow.',cat:'time'}],
  2:[{w:'before',th:'‡∏Å‡πà‡∏≠‡∏ô',s:'Wash your hands before lunch.',cat:'time'},{w:'after',th:'‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å',s:'We play after school.',cat:'time'},{w:'between',th:'‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á',s:'The ball is between the shoes.',cat:'thing'},{w:'under',th:'‡πÉ‡∏ï‡πâ',s:'The cat is under the table.',cat:'thing'},{w:'over',th:'‡πÄ‡∏´‡∏ô‡∏∑‡∏≠/‡∏Ç‡πâ‡∏≤‡∏°',s:'The plane flies over the city.',cat:'thing'},{w:'inside',th:'‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô',s:'The toy is inside the box.',cat:'thing'},{w:'outside',th:'‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å',s:'We eat outside today.',cat:'thing'},{w:'across',th:'‡∏Ç‡πâ‡∏≤‡∏°',s:'Walk across the street.',cat:'thing'},{w:'around',th:'‡∏£‡∏≠‡∏ö‡πÜ',s:'Run around the park.',cat:'thing'},{w:'through',th:'‡∏ú‡πà‡∏≤‡∏ô',s:'Go through the door.',cat:'thing'},{w:'near',th:'‡πÉ‡∏Å‡∏•‡πâ',s:'The school is near my house.',cat:'thing'},{w:'next to',th:'‡∏ñ‡∏±‡∏î‡∏à‡∏≤‡∏Å/‡∏Ç‡πâ‡∏≤‡∏á‡πÜ',s:'Sit next to me, please.',cat:'thing'},{w:'in front of',th:'‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤',s:'Stand in front of the class.',cat:'thing'},{w:'behind',th:'‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á',s:'The ball is behind the chair.',cat:'thing'},{w:'along',th:'‡πÑ‡∏õ‡∏ï‡∏≤‡∏°',s:'Walk along the river.',cat:'thing'},{w:'borrow',th:'‡∏¢‡∏∑‡∏°',s:'Can I borrow your pencil?',cat:'verb'},{w:'return',th:'‡∏Ñ‡∏∑‡∏ô',s:'Please return the book.',cat:'verb'},{w:'carry',th:'‡∏ñ‡∏∑‡∏≠/‡πÅ‡∏ö‡∏Å',s:'Carry the bag carefully.',cat:'verb'},{w:'choose',th:'‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',s:'Choose one picture.',cat:'verb'},{w:'answer',th:'‡∏ï‡∏≠‡∏ö',s:'Answer the question.',cat:'verb'},{w:'explain',th:'‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢',s:'Please explain again.',cat:'verb'},{w:'invite',th:'‡πÄ‡∏ä‡∏¥‡∏ç/‡∏ä‡∏ß‡∏ô',s:'I invite my friend.',cat:'verb'},{w:'learn',th:'‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ',s:'We learn English every day.',cat:'verb'},{w:'build',th:'‡∏™‡∏£‡πâ‡∏≤‡∏á',s:'They build a small house.',cat:'verb'},{w:'repair',th:'‡∏ã‡πà‡∏≠‡∏°',s:'Dad will repair the bike.',cat:'verb'},{w:'collect',th:'‡πÄ‡∏Å‡πá‡∏ö/‡∏™‡∏∞‡∏™‡∏°',s:'Collect the stickers.',cat:'verb'},{w:'decide',th:'‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à',s:'Decide carefully.',cat:'verb'},{w:'practice',th:'‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô',s:'Practice speaking English.',cat:'verb'},{w:'whisper',th:'‡∏Å‡∏£‡∏∞‡∏ã‡∏¥‡∏ö',s:'Please whisper in the library.',cat:'verb'}],
  3:[{w:'because',th:'‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ß‡πà‡∏≤',s:'I stay home because it rains.',cat:'thing'},{w:'but',th:'‡πÅ‡∏ï‡πà',s:'It is small but heavy.',cat:'thing'},{w:'or',th:'‡∏´‡∏£‡∏∑‡∏≠',s:'Tea or milk?',cat:'thing'},{w:'and',th:'‡πÅ‡∏•‡∏∞',s:'Bread and butter.',cat:'thing'},{w:'so',th:'‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô',s:'I was late, so I ran.',cat:'thing'},{w:'while',th:'‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ó‡∏µ‡πà',s:'Read while you wait.',cat:'thing'},{w:'bigger',th:'‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤',s:'An elephant is bigger than a dog.',cat:'adj'},{w:'smaller',th:'‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤',s:'This pencil is smaller.',cat:'adj'},{w:'faster',th:'‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤',s:'He runs faster than me.',cat:'adj'},{w:'slower',th:'‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤',s:'The turtle is slower.',cat:'adj'},{w:'longer',th:'‡∏¢‡∏≤‡∏ß‡∏Å‡∏ß‡πà‡∏≤',s:'This road is longer.',cat:'adj'},{w:'shorter',th:'‡∏™‡∏±‡πâ‡∏ô‡∏Å‡∏ß‡πà‡∏≤',s:'My hair is shorter now.',cat:'adj'},{w:'kinder',th:'‡πÉ‡∏à‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤',s:'Be kinder to others.',cat:'adj'},{w:'taller',th:'‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤',s:'She is taller than me.',cat:'adj'},{w:'drawing',th:'‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ',s:'I like drawing.',cat:'verb'},{w:'swimming',th:'‡∏Å‡∏≤‡∏£‡∏ß‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥',s:'Swimming is fun.',cat:'verb'},{w:'reading',th:'‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠',s:'Reading helps me learn.',cat:'verb'},{w:'cooking',th:'‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£',s:'Mom enjoys cooking.',cat:'verb'},{w:'planting',th:'‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ',s:'We are planting trees.',cat:'verb'},{w:'cleaning',th:'‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î',s:'Cleaning is important.',cat:'verb'},{w:'painting',th:'‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏™‡∏µ',s:'Painting is relaxing.',cat:'verb'},{w:'singing',th:'‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á',s:'Singing makes me happy.',cat:'verb'},{w:'dancing',th:'‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô',s:'Dancing is great exercise.',cat:'verb'},{w:'camping',th:'‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏Ñ‡∏°‡∏õ‡πå',s:'We go camping this weekend.',cat:'verb'},{w:'always',th:'‡πÄ‡∏™‡∏°‡∏≠',s:'I always brush my teeth.',cat:'time'},{w:'usually',th:'‡πÇ‡∏î‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥',s:'She usually walks to school.',cat:'time'},{w:'often',th:'‡∏ö‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á',s:'They often play chess.',cat:'time'},{w:'sometimes',th:'‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á',s:'We sometimes eat out.',cat:'time'},{w:'rarely',th:'‡∏ô‡∏≤‡∏ô‡πÜ ‡∏Ñ‡∏£‡∏±‡πâ‡∏á',s:'He rarely watches TV.',cat:'time'},{w:'never',th:'‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢',s:'I never skip homework.',cat:'time'},{w:'early',th:'‡πÄ‡∏ä‡πâ‡∏≤/‡πÄ‡∏£‡πá‡∏ß',s:'Come early to class.',cat:'time'},{w:'late',th:'‡∏™‡∏≤‡∏¢',s:'Do not be late.',cat:'time'}]
};
let currentSetKey=1,CARDS=SETS[currentSetKey],order=[],idx=0,flipped=false,preferFemale=true,defaultVoice=null,selectedVoiceURI=localStorage.getItem('voiceURI')||'';
const cardEl=document.getElementById('card'),wordEl=document.getElementById('word'),thaiEl=document.getElementById('thai'),sentEl=document.getElementById('sentence'),catBadge=document.getElementById('catBadge'),catBadgeBack=document.getElementById('catBadgeBack'),count=document.getElementById('count'),countBack=document.getElementById('countBack'),setNum=document.getElementById('setNum');
const btnKnow=document.getElementById('btnKnow'),btnAgain=document.getElementById('btnAgain'),btnSpeak=document.getElementById('btnSpeak'),btnSets=document.getElementById('btnSets'),btnGender=document.getElementById('btnGender'),rate=document.getElementById('rate'),rateLbl=document.getElementById('rateLbl'),voiceSelect=document.getElementById('voiceSelect');
const modal=document.getElementById('modal'),setRow=document.getElementById('setRow'),fileInput=document.getElementById('fileInput'),closeModal=document.getElementById('closeModal');
const CAT_LABEL={adj:'adjective',verb:'verb',thing:'thing',animal:'animal',time:'time'},CAT_COLOR={adj:'var(--adj)',verb:'var(--verb)',thing:'var(--thing)',animal:'var(--animal)',time:'var(--time)'};
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function startSet(key){currentSetKey=key;CARDS=SETS[currentSetKey];order=shuffle([...CARDS.keys()]);idx=0;flipped=false;cardEl.classList.remove('flipped');setNum.textContent=String(currentSetKey);paint()}
function paint(){const item=CARDS[order[idx]];wordEl.textContent=item.w;thaiEl.textContent=item.th;sentEl.textContent=item.s;catBadge.textContent=CAT_LABEL[item.cat]||'';catBadgeBack.textContent=CAT_LABEL[item.cat]||'';count.textContent=`${idx+1} / ${order.length}`;countBack.textContent=`${idx+1} / ${order.length}`;document.querySelector('.front').style.background=CAT_COLOR[item.cat]||'#fff'}
function nextCard(){idx++;if(idx>=order.length){order=shuffle([...CARDS.keys()]);idx=0}flipped=false;cardEl.classList.remove('flipped');paint()}
cardEl.addEventListener('click',()=>{flipped=!flipped;cardEl.classList.toggle('flipped',flipped)});
btnKnow.addEventListener('click',()=>{order.splice(idx,1);if(order.length===0){order=shuffle([...CARDS.keys()]);idx=0}else if(idx>=order.length){idx=0}flipped=false;cardEl.classList.remove('flipped');paint()});
btnAgain.addEventListener('click',()=>{const cur=order[idx];order.splice(idx,1);const insertAt=Math.min(order.length,2+Math.floor(Math.random()*3));order.splice(insertAt,0,cur);nextCard()});

// Voice utilities
function scoreVoice(v){let s=0;if(/en/i.test(v.lang))s+=10;if(/US|GB|AU/i.test(v.lang))s+=5;const female=/Samantha|Aria|Jenny|Victoria|Zira|Karen|Serena|Olivia|Allison|Amy|Emma|Joanna|Google US English|Female/i;const male=/Daniel|Alex|Matthew|Brian|Justin|Joey|Male/i;if(preferFemale&&female.test(v.name))s+=8;if(!preferFemale&&male.test(v.name))s+=6;return s}
function pickDefaultVoice(){if(!('speechSynthesis'in window))return null;const all=speechSynthesis.getVoices();const en=all.filter(v=>/en/i.test(v.lang));en.sort((a,b)=>scoreVoice(b)-scoreVoice(a));return en[0]||null}
function populateVoiceList(){ if(!('speechSynthesis' in window)) return; const all=speechSynthesis.getVoices(); const en=all.filter(v=>/en/i.test(v.lang)); en.sort((a,b)=>a.name.localeCompare(b.name)); voiceSelect.innerHTML='<option value=\"\">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</option>'; en.forEach(v=>{ const opt=document.createElement('option'); opt.value=v.voiceURI||v.name; opt.textContent=`${v.name} ‚Äì ${v.lang}`; if(selectedVoiceURI && opt.value===selectedVoiceURI) opt.selected=true; voiceSelect.appendChild(opt); }); }
function getSelectedVoice(){ if(!('speechSynthesis'in window))return null; const all=speechSynthesis.getVoices(); return all.find(v=> (v.voiceURI||v.name)===selectedVoiceURI ) || null; }

function refreshVoice(){ defaultVoice = pickDefaultVoice(); populateVoiceList(); }
if('speechSynthesis' in window){ refreshVoice(); window.speechSynthesis.onvoiceschanged = refreshVoice; }

btnGender.addEventListener('click',()=>{preferFemale=!preferFemale;btnGender.textContent='‡πÄ‡∏™‡∏µ‡∏¢‡∏á: '+(preferFemale?'‡∏´‡∏ç‡∏¥‡∏á':'‡∏ä‡∏≤‡∏¢'); defaultVoice = pickDefaultVoice();});

voiceSelect.addEventListener('change', ()=>{ selectedVoiceURI = voiceSelect.value || ''; localStorage.setItem('voiceURI', selectedVoiceURI); });

rate.addEventListener('input',()=>{ rateLbl.textContent=Number(rate.value).toFixed(2)+'x'; localStorage.setItem('rate', rate.value); });
// restore rate if saved
const savedRate = localStorage.getItem('rate'); if(savedRate){ rate.value = savedRate; rateLbl.textContent = Number(savedRate).toFixed(2)+'x'; }

btnSpeak.addEventListener('click',()=>{
  if(!('speechSynthesis' in window)) return alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á');
  speechSynthesis.cancel();
  const item=CARDS[order[idx]];
  const ut=new SpeechSynthesisUtterance(flipped?item.s:item.w);
  const chosen = getSelectedVoice();
  if(chosen) ut.voice = chosen; else if(defaultVoice) ut.voice = defaultVoice;
  ut.rate = parseFloat(localStorage.getItem('rate') || rate.value || '0.9');
  ut.lang = (ut.voice && ut.voice.lang) || (defaultVoice && defaultVoice.lang) || 'en-US';
  speechSynthesis.speak(ut);
});

window.addEventListener('keydown',e=>{if(['INPUT','SELECT','TEXTAREA'].includes(document.activeElement.tagName))return;if(e.key===' '){e.preventDefault();btnSpeak.click()}});
function openSets(){modal.classList.add('open');modal.setAttribute('aria-hidden','false');renderSetButtons()} function closeSets(){modal.classList.remove('open');modal.setAttribute('aria-hidden','true')}
btnSets.addEventListener('click',openSets); closeModal.addEventListener('click',closeSets);
function renderSetButtons(){setRow.innerHTML='';Object.keys(SETS).sort((a,b)=>Number(a)-Number(b)).forEach(key=>{const b=document.createElement('button');b.className='pill';b.textContent='‡∏ä‡∏∏‡∏î '+key;b.onclick=()=>{closeSets();startSet(Number(key))};setRow.appendChild(b)})}
fileInput.addEventListener('change',async e=>{const file=e.target.files[0];if(!file)return;const text=await file.text();let arr=[];if(file.name.toLowerCase().endsWith('.json')){try{const data=JSON.parse(text);if(Array.isArray(data))arr=data}catch(err){alert('‡πÑ‡∏ü‡∏•‡πå JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');return}}else{arr=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(line=>{const [w,th,s,cat]=line.split(',').map(x=>x?.trim()?.replace(/^"|"$/g,''));return {w,th,s,cat}}).filter(x=>x&&x.w)} if(!arr.length)return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå');const nextNum=Math.max(...Object.keys(SETS).map(n=>Number(n)))+1;SETS[nextNum]=arr;closeSets();startSet(nextNum)});
startSet(1);

// Register service worker
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./service-worker.js');
  });
}
</script>
</body>
</html>
