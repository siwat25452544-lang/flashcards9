<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Trainer ‚Ä¢ Flashcards + Match + Audio</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#111827" />
  <style>
    :root{ --bg:#f7f8fb;--ink:#0f1629;--muted:#6b7280;--card:#fff;--border:#e5e7eb;
      --accent:#111827;--shadow:0 10px 20px rgba(2,6,23,.06),0 2px 6px rgba(2,6,23,.05);
      --ok:#10b981;--warn:#f59e0b;--bad:#ef4444;
      --pastel-adj:#FFF6BF;--pastel-verb:#DDEBFF;--pastel-thing:#EAF7E8;--pastel-animal:#FDE4EF;--pastel-time:#FFE8D2; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai","Noto Sans",sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .btn{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;font-size:15px}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .btn.ok{background:#10b981;color:#fff;border-color:#0ea371}
    .btn.warn{background:#f59e0b;color:#fff;border-color:#d97706}
    .muted{color:var(--muted);font-size:13px}
    .title{font-size:22px;font-weight:900;margin:0}
    .tabs .btn{min-width:150px;justify-content:center}
    .grid{display:grid;gap:14px} .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .select,input[type=text]{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;font-size:15px}
    .slider{width:240px}
    .ds{border:1px solid var(--border);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
    .ds.on{background:#111827;color:#fff;border-color:#111827}
    /* Flashcard */
    .flash-wrap{display:flex;flex-direction:column;align-items:center}
    .flash-card{width:min(900px,92vw);aspect-ratio:16/10;border-radius:26px;box-shadow:var(--shadow);border:1px solid var(--border);
      position:relative;overflow:hidden;cursor:pointer;display:flex;align-items:center;justify-content:center;text-align:center;background:#fff}
    .flash-word{font-size:clamp(44px,9vw,84px);font-weight:900;letter-spacing:.4px}
    .flash-hint{font-size:14px;color:var(--muted);margin-top:8px}
    .flash-badge{position:absolute;top:14px;left:14px;background:rgba(0,0,0,.65);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    .flash-count{position:absolute;top:14px;right:14px;background:#111;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    .flash-controls{display:flex;justify-content:center;gap:10px;margin-top:12px}
    .flash-controls .btn{min-width:120px}
  </style>
</head>
<body>
<div class="container">
  <header class="row" style="justify-content:space-between">
    <div>
      <h1 class="title">Flashcards ‚Äì GoodNotes Style + ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</h1>
      <div class="muted">Flashcards ‚Ä¢ ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥ ‚Ä¢ ‡∏ó‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏à‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‚Ä¢ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå/URL ‚Ä¢ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å/‡∏•‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
    </div>
    <div class="row">
      <button class="btn" id="openModal">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î</button>
    </div>
  </header>

  <section class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="row" style="align-items:center">
        <div class="muted">‡πÇ‡∏´‡∏°‡∏î:</div>
        <nav class="row tabs">
          <button class="btn primary" data-tab="flash">Flashcards</button>
          <button class="btn" data-tab="match">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥</button>
          <button class="btn" data-tab="listen">‡∏ó‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏à‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
        </nav>
      </div>
      <div class="row">
        <div class="row"><span class="muted">‡πÄ‡∏™‡∏µ‡∏¢‡∏á: </span>
          <select class="select" id="voiceSelect"><option value="__auto__">‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option></select>
        </div>
        <div class="row">
          <div class="muted">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</div>
          <input class="slider" type="range" min="60" max="130" value="90" id="rate" />
        </div>
      </div>
    </div>
  </section>

  <div id="view" class="card" style="margin-top:12px;min-height:340px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</div>

  <!-- Modal -->
  <div id="modal" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9998">
    <div class="card" style="width:min(680px,96vw)">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î</div>
        <button class="btn" id="closeModal">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="btn">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î CSV/JSON
          <input type="file" id="fileInput" accept=".csv,.json,text/csv,application/json" style="display:none">
        </label>
        <button class="btn" id="exportSets">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
        <button class="btn" id="wipeDB">üóëÔ∏è ‡∏•‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
      <div style="margin-top:10px" class="card">
        <div style="font-weight:800;margin-bottom:8px">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å URL</div>
        <div class="row">
          <input id="urlInput" type="text" placeholder="./data/week1_set1.csv" style="flex:1">
          <button class="btn primary" id="importURL">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å URL</button>
        </div>
        <div class="muted" style="margin-top:6px">
          ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö CSV (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: <code>w,th,s,cat</code> ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡πÄ‡∏ä‡πà‡∏ô <code>word,thai,sentences,category</code>) ‡πÅ‡∏•‡∏∞ JSON (array ‡∏Ç‡∏≠‡∏á {w,th,s,cat}).
        </div>
      </div>
      <div style="margin-top:12px">
        <div class="muted" style="margin-bottom:6px">‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</div>
        <div id="datasets" class="row" style="gap:8px;flex-wrap:wrap"></div>
      </div>
    </div>
  </div>
</div>

<script>
const KEY_DATASETS="en_trainer_datasets_v1", KEY_ACTIVE="en_trainer_active_v1", KEY_VOICE="en_trainer_voice_v1";
const qs=(s)=>document.querySelector(s), view=qs('#view');
const toast=(t)=>{ console.log('[toast]',t); };

const store={
  get datasets(){ try{return JSON.parse(localStorage.getItem(KEY_DATASETS)||"[]")}catch{return[]} },
  set datasets(v){ localStorage.setItem(KEY_DATASETS, JSON.stringify(v)); },
  get active(){ return localStorage.getItem(KEY_ACTIVE)||"builtin"; },
  set active(v){ localStorage.setItem(KEY_ACTIVE, v); },
  get voice(){ return localStorage.getItem(KEY_VOICE)||""; },
  set voice(v){ localStorage.setItem(KEY_VOICE, v); },
};

// Seed words
const BUILTIN=[
  {id:1,w:"happy",th:"‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç",s:["I am happy today.","I feel happy when I read."],cat:"adjective"},
  {id:2,w:"borrow",th:"‡∏¢‡∏∑‡∏°",s:["Can I borrow your pen?","Please borrow a book."],cat:"verb"}
];

let datasets = store.datasets;
if(!datasets.find(d=>d.id==="builtin")){
  datasets=[{id:"builtin",name:"Built-in",words:[...BUILTIN]}];
  store.datasets=datasets;
}
let state = { tab:"flash", rate:0.9, voice: store.voice, active: store.active };

function currentWords(){ const ds = datasets.find(d=>d.id===state.active) || datasets[0]; return ds.words||[]; }

/* ===== CSV helpers ===== */
function splitCSVLine(line){const out=[];let cur='',inQ=false;
  for(let i=0;i<line.length;i++){const ch=line[i];
    if(ch==='\"'){ if(inQ&&line[i+1]==='\"'){cur+='\"';i++;} else inQ=!inQ; }
    else if(ch===','&&!inQ){out.push(cur);cur='';}
    else cur+=ch;}
  out.push(cur);return out;
}
function normalizeHeader(names){
  const map={ w:['w','word','english','en'],
              th:['th','thai','meaning','translate','‡πÅ‡∏õ‡∏•','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢'],
              s:['s','sentences','sentence','examples','example','ex','ex1','ex2','ex3'],
              cat:['cat','category','‡∏´‡∏°‡∏ß‡∏î','‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'] };
  const lower = names.map(n=>(n||'').trim().toLowerCase());
  const pick=(keys)=> lower.findIndex(h=> keys.includes(h));
  return { w:pick(map.w), th:pick(map.th), s:pick(map.s), cat:pick(map.cat) };
}
function parseCSV(text){
  text = (text||'').replace(/^\uFEFF/, ''); // strip BOM
  const lines = text.replace(/\r/g,'').split(/\r?\n/).filter(Boolean);
  if(!lines.length) return [];
  const headerRaw = splitCSVLine(lines[0]).map(h=>(h||'').trim());
  const idx = normalizeHeader(headerRaw);
  if(idx.w<0 || idx.th<0) throw new Error('bad_header');
  const out=[], startId=Date.now();
  for(let i=1;i<lines.length;i++){
    const row = splitCSVLine(lines[i]); if(row.every(x=>!String(x||'').trim())) continue;
    const get=(j)=> (j>=0 && j<row.length ? (row[j]||'').trim() : '');
    const w=get(idx.w); if(!w) continue;
    const th=get(idx.th);
    const sRaw=get(idx.s);
    const cat=get(idx.cat);
    const sArr = sRaw ? sRaw.split('|').map(x=>x.trim()).filter(Boolean) : [];
    out.push({ id:startId+i, w, th, s: sArr.length? sArr : (sRaw||''), cat });
  }
  return out;
}

/* ===== Import from URL (robust) ===== */
async function importFromURL(url){
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('http_'+res.status);
    const text = await res.text();
    console.log('[CSV first line]', (text.split(/\r?\n/)[0]||'').slice(0,200));
    const words = parseCSV(text).map(x=> ({...x, s: Array.isArray(x.s)? x.s : (x.s? [x.s] : [])}));
    if(!words.length) throw new Error('empty');
    const dsId="csv_"+Date.now(); const name=url.split('/').pop().split('?')[0];
    datasets = store.datasets; datasets.push({id:dsId, name, words}); store.datasets=datasets; store.active=dsId; state.active=dsId;
    renderDatasets(); renderAll(true); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å URL ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }catch(err){
    console.error('Import URL failed:', err);
    let msg='‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
    if(String(err).includes('bad_header')) msg='‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ w ‡πÅ‡∏•‡∏∞ th (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö word/thai/sentences/category ‡∏î‡πâ‡∏ß‡∏¢)';
    if(String(err).includes('http_')) msg='‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Å‡∏û‡∏≤‡∏ò/‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏ô GitHub ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏∞‡∏Å‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå)';
    alert(msg);
  }
}

/* ===== Other app code (stripped to essentials to keep size small) ===== */
function renderDatasets(){
  const wrap = qs('#datasets'); if(!wrap) return; wrap.innerHTML='';
  datasets.forEach(ds=>{
    const b=document.createElement('button'); b.className='ds'+(ds.id===state.active?' on':''); b.textContent=ds.name||'CSV';
    b.onclick=()=>{ state.active=ds.id; store.active=ds.id; renderAll(true); };
    wrap.appendChild(b);
  });
}
function speak(text){
  if(!('speechSynthesis' in window)) return;
  const u=new SpeechSynthesisUtterance(text), voices=speechSynthesis.getVoices();
  const chosen = state.voice ? voices.find(v=>v.name===state.voice) : voices.find(v=> v.lang?.toLowerCase().startsWith('en'));
  if(chosen) u.voice = chosen; u.rate = state.rate; speechSynthesis.cancel(); speechSynthesis.speak(u);
}
const PASTEL={ adjective:'var(--pastel-adj)',verb:'var(--pastel-verb)',thing:'var(--pastel-thing)',animal:'var(--pastel-animal)',time:'var(--pastel-time)',preposition:'var(--pastel-thing)' };
const flashState = { order:[], idx:0, flipped:false };
function Flashcards(fresh=true){
  const items = currentWords(); if(!items.length) return document.createTextNode('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ');
  if(fresh || !flashState.order.length){ flashState.order=[...items]; flashState.idx=0; flashState.flipped=false; }
  const wrap=document.createElement('div'); wrap.className='flash-wrap';
  const card=document.createElement('div'); card.className='flash-card'; wrap.appendChild(card);
  function draw(){
    const c=flashState.order[flashState.idx%flashState.order.length]; const bg=PASTEL[c.cat]||'var(--pastel-adj)'; card.style.background=bg;
    card.innerHTML = !flashState.flipped
      ? `<div class="flash-badge">${(c.cat||'word')}</div><div class="flash-count">${flashState.idx+1}/${flashState.order.length}</div>
         <div><div class="flash-word">${c.w}</div><div class="flash-hint">‡πÅ‡∏ï‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏•‡∏¥‡∏Å</div></div>`
      : `<div class="flash-badge">${(c.cat||'word')}</div><div class="flash-count">${flashState.idx+1}/${flashState.order.length}</div>
         <div>${c.th?`<div style="font-size:clamp(22px,3.5vw,34px);font-weight:800;margin-bottom:8px">${c.th}</div>`:''}
         ${(Array.isArray(c.s)?c.s:[c.s]).filter(Boolean).map(s=>`<div style="font-size:clamp(18px,3vw,26px);line-height:1.6;margin-top:6px">${s}</div>`).join('')||'<div class="flash-hint">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</div>'}</div>`;
  }
  card.onclick=()=>{ flashState.flipped=!flashState.flipped; draw(); };
  draw();
  const controls=document.createElement('div'); controls.className='flash-controls';
  const again=document.createElement('button'); again.className='btn warn'; again.textContent='‚ü≤ ‡∏¢‡∏±‡∏á‡∏à‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
  const readB=document.createElement('button'); readB.className='btn primary'; readB.textContent='üîä ‡∏≠‡πà‡∏≤‡∏ô';
  const know=document.createElement('button'); know.className='btn ok'; know.textContent='‚úì ‡∏à‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß';
  readB.onclick=()=>{ const c=flashState.order[flashState.idx%flashState.order.length]; speak(c.w); };
  know.onclick=()=>{ flashState.order.splice(flashState.idx,1); if(!flashState.order.length){ flashState.order=[...items]; flashState.idx=0; } flashState.flipped=false; draw(); };
  again.onclick=()=>{ const cur=flashState.order[flashState.idx]; flashState.order.splice(flashState.idx,1); flashState.order.splice(Math.min(flashState.order.length,3),0,cur); flashState.flipped=false; draw(); };
  controls.append(again,readB,know); wrap.appendChild(controls); return wrap;
}
function ListenGame(){ return document.createTextNode('Listen Game (stub in patch).'); }
function MatchGame(){ return document.createTextNode('Match Game (stub in patch).'); }

function renderAll(fresh){
  view.innerHTML='';
  if(state.tab==='flash')  view.appendChild(Flashcards(fresh));
  if(state.tab==='listen') view.appendChild(ListenGame());
  if(state.tab==='match')  view.appendChild(MatchGame());
}
document.addEventListener('DOMContentLoaded', ()=>{
  renderAll(true);
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js?v=10').catch(()=>{}); }
});
document.querySelectorAll('.tabs .btn').forEach(b=> b.onclick=()=>{ state.tab=b.dataset.tab; document.querySelectorAll('.tabs .btn').forEach(x=>x.classList.toggle('primary', x===b)); renderAll(true); });
qs('#openModal').onclick=()=>{ document.getElementById('modal').style.display='flex'; renderDatasets(); };
qs('#closeModal').onclick=()=>{ document.getElementById('modal').style.display='none'; };
qs('#voiceSelect').onchange=(e)=>{ state.voice = e.target.value==='__auto__' ? '' : e.target.value; store.voice=state.voice; };
qs('#rate').oninput=(e)=>{ state.rate = Number(e.target.value)/100; };

// Modal actions
qs('#fileInput').addEventListener('change', async (e)=>{
  const file=e.target.files?.[0]; if(!file) return;
  const text=await file.text(); console.log('[Local CSV first line]', (text.split(/\\r?\\n/)[0]||'').slice(0,200));
  let words=[];
  if(file.name.toLowerCase().endsWith('.json')){
    const data = JSON.parse(text);
    words=(Array.isArray(data)?data:[]).map((x,i)=>({id:Date.now()+i,w:x.w,th:x.th||'',s:Array.isArray(x.s)?x.s:(x.s?[x.s]:[]),cat:x.cat||''})).filter(x=>x.w);
  }else{
    words=parseCSV(text).map(x=>({...x,s:Array.isArray(x.s)?x.s:(x.s?[x.s]:[])}));
  }
  if(!words.length) return alert('‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  const dsId="csv_"+Date.now(); const name=file.name.replace(/\\.(csv|txt|json)$/i,'');
  datasets=store.datasets; datasets.push({id:dsId,name,words}); store.datasets=datasets; store.active=dsId; state.active=dsId;
  renderDatasets(); renderAll(true); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
});
qs('#importURL').onclick=async ()=>{
  const url = qs('#urlInput').value.trim(); if(!url) return alert('‡∏Å‡∏£‡∏≠‡∏Å URL ‡∏Å‡πà‡∏≠‡∏ô');
  await importFromURL(url);
};
</script>
</body>
</html>
